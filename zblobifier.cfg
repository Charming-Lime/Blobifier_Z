[gcode_macro _BLOBIFIER_VARS]
# Calibration Constants
variable_bottom: 27.75
variable_top: -2
variable_span: 27.4

# Happy Hare Blob Tuning Parameters
variable_purge_start: 0.2
variable_z_raise: 12.0                # Total potential Z raise
variable_z_raise_exp: 0.85            # Exponential factor (0.85 is standard)
variable_max_iteration_length: 20.0   # Max mm per blob
variable_iteration_z_raise: 2.5       # mm to raise Z per step
variable_eject_hop: 1.0               # Lift nozzle before ejection
variable_pressure_release_time: 1000  # ms
variable_retract_between_blobs: 2.0   # mm
variable_part_cooling_fan: 0.3        # 30% fan during purge
variable_part_cooling_fan_deposit: 1.0 # 100% fan to freeze blob for ejection
gcode: # Required but empty


[servo blob_tray]
pin: !PA8
maximum_servo_angle: 180
minimum_pulse_width: 0.0006
maximum_pulse_width: 0.00194
initial_angle: 180

[servo blobifier_z]
pin: !PE5
maximum_servo_angle: 180
minimum_pulse_width: 0.0005
maximum_pulse_width: 0.00205
initial_angle: 0

[gcode_macro SET_BLOBIFIER]
gcode:
  {% set vars = printer["gcode_macro _BLOBIFIER_VARS"] %}
  {% set bottom = vars.bottom %}
  {% set top    = vars.top %}

  {% if 'Z' in params %}
    {% set z_param = params.Z|upper %}
    {% if z_param == "UP" %}
      {% set z_pos = top %}
    {% elif z_param == "DOWN" %}
      {% set z_pos = bottom %}
    {% else %}
      {% set z_pos = z_param|float %}
    {% endif %}
    {% set z_angle = (z_pos - bottom) / (top - bottom) * 180 %}
    {% set z_angle = [0, [z_angle, 180]|min]|max %}
    SET_SERVO SERVO=blobifier_z ANGLE={z_angle}
  {% endif %}

  {% if 'TRAY' in params %}
    {% set tray_state = params.TRAY|upper %}
    {% if tray_state == "IN" %}
      SET_SERVO SERVO=blob_tray ANGLE=180
    {% elif tray_state == "OUT" %}
      SET_SERVO SERVO=blob_tray ANGLE=0
    {% endif %}
  {% endif %}

[gcode_macro _BLOB_Z_SPEED_TEST]
description: Cycles Blobifier Z between UP and DOWN with custom delay. Usage: _BLOB_Z_SPEED_TEST TIME=750
gcode:
  # Default to 750ms as the Z servo usually has more mass to move than the tray
  {% set delay = params.TIME|default(750)|int %}

  SET_BLOBIFIER Z=UP
  G4 P{delay}
  SET_BLOBIFIER Z=DOWN
  G4 P{delay}
  SET_BLOBIFIER Z=UP
  G4 P{delay}
  SET_BLOBIFIER Z=DOWN
  G4 P{delay}
  SET_BLOBIFIER Z=UP

  { action_respond_info("Z speed test complete with %dms delay." % delay) }

[gcode_macro _BLOB_TRAY_SPEED_TEST]
description: Cycles the tray with a custom delay to test servo speed/reliability. _BLOB_TRAY_SPEED_TEST TIME=400
gcode:
  # Default to 400ms if no TIME parameter is provided
  {% set delay = params.TIME|default(400)|int %}

  SET_BLOBIFIER TRAY=IN
  G4 P{delay}
  SET_BLOBIFIER TRAY=OUT
  G4 P{delay}
  SET_BLOBIFIER TRAY=IN
  G4 P{delay}
  SET_BLOBIFIER TRAY=OUT
  G4 P{delay}
  SET_BLOBIFIER TRAY=IN

  { action_respond_info("Tray speed test complete with %dms delay." % delay) }

[gcode_macro _BLOB_DELAY_Z]
description: Delays long enough for a blob z to compleate a move
gcode:
    G4 P750

[gcode_macro _BLOB_DELAY_TRAY]
description: Delays long enough for a blob tray to compleate a move
gcode:
    G4 P400

[gcode_macro _BLOB_RESET]
description: moves blobifier full down and tray in
gcode:
   SET_BLOBIFIER TRAY=IN Z=DOWN
   _BLOB_DELAY_Z

[gcode_macro _BLOB_UP]
description: moves blobifier full up and tray out
gcode:
   SET_BLOBIFIER TRAY=OUT Z=UP
   _BLOB_DELAY_Z

[gcode_macro _BLOB_SYNC_MOVE]
description: Internal helper to sync servo Z moves with extrusion via slicing
gcode:
    {% set z_start = params.Z_START|default(0)|float %}
    {% set z_end = params.Z_END|default(0)|float %}
    {% set e_dist = params.E_DIST|default(10)|float %}
    {% set e_speed = params.E_SPEED|default(300)|float %}
    {% set steps = params.STEPS|default(100)|int %}

    {% set e_step = e_dist / steps %}
    {% set z_total_dist = z_end - z_start %}
    {% set z_step_dist = z_total_dist / steps %}
    {% set step_time = (e_dist / (e_speed / 60)) / steps %}

    SAVE_GCODE_STATE NAME=blob_sync_state
    M83
    {% for i in range(steps) %}
        {% set current_z = z_start + (z_step_dist * (i + 1)) %}
        G1 E{e_step} F{e_speed}
        SET_BLOBIFIER Z={current_z}
        G4 P{(step_time * 1000)|int}
    {% endfor %}
    RESTORE_GCODE_STATE NAME=blob_sync_state



[gcode_macro BLOBIFIER]
description: Happy Hare style purge with exponential Z-raise and fan control
gcode:
    {% set vars = printer["gcode_macro _BLOBIFIER_VARS"] %}
    {% set purge_len = params.PURGE_LENGTH|default(40)|float %}

    # Calculate Iterations
    {% set iterations = (purge_len / vars.max_iteration_length)|round(0, 'ceil')|int %}
    {% set step_purge = purge_len / iterations %}

    # Save State & Prep Fan
    SAVE_GCODE_STATE NAME=blobifier_state
    {% set old_fan = printer.fan.speed %}
    M106 S{(vars.part_cooling_fan * 255)|int}

    # 1. Setup Tray - Start at 0 (Nozzle contact)
    SET_BLOBIFIER TRAY=OUT Z=0
    _BLOB_DELAY_Z

    M83 # Relative extrusion

    # 2. Purge Loop
    {% for i in range(iterations) %}
        # Calculate Exponential Z Raise (Lowering the tray physically)
        # Note: We use positive offsets because 0 is Top and 27.75 is Bottom.
        {% set total_extruded_start = i * step_purge %}
        {% set total_extruded_end = (i + 1) * step_purge %}

        # Exponential math for start and end of this specific slice
        {% set z_start = ((total_extruded_start / purge_len)**vars.z_raise_exp) * vars.z_raise %}
        {% set z_end = ((total_extruded_end / purge_len)**vars.z_raise_exp) * vars.z_raise %}

        # Sync Move: Tray moves from z_start to z_end while extruding step_purge
        _BLOB_SYNC_MOVE Z_START={z_start} Z_END={z_end} E_DIST={step_purge} E_SPEED=300 STEPS=20

        # Intermediate Retract & Dwell
        {% if i < (iterations - 1) %}
            G1 E-{vars.retract_between_blobs} F3000
            G4 P250
            G1 E{vars.retract_between_blobs} F3000
        {% endif %}
    {% endfor %}

    # 3. Pressure Release & Freeze
    M106 S{(vars.part_cooling_fan_deposit * 255)|int}
    G4 P{vars.pressure_release_time}
    G1 E-1.5 F3000

    # 4. Eject Sequence
    SET_BLOBIFIER Z=DOWN
    _BLOB_DELAY_Z
    SET_BLOBIFIER TRAY=IN
    _BLOB_DELAY_TRAY

    # Restore Fan and State
    M106 S{(old_fan * 255)|int}
    RESTORE_GCODE_STATE NAME=blobifier_state
