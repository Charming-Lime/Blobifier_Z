#####################################################################
# BLOBIFIER HARDWARE DEFINITIONS (Octopus Pro v1.1)
#####################################################################

[servo blob_tray]
pin: !PA8                         # Pull-up PWM signal (FAN0 Header)
maximum_servo_angle: 180
minimum_pulse_width: 0.0006       # Calibrated: 10 degrees
maximum_pulse_width: 0.00194      # Calibrated: 130 degrees
initial_angle: 180                # Start fully retracted (IN)

[servo blobifier_z]
pin: !PE5                         # Pull-up PWM signal (FAN1 Header)
maximum_servo_angle: 180
minimum_pulse_width: 0.0005
maximum_pulse_width: 0.00205
initial_angle: 0                  # Start fully down (DOWN)

#####################################################################
# BLOBIFIER VARIABLES & TUNING
#####################################################################

[gcode_macro _BLOBIFIER_VARS]
description: Configuration and State variables for Blobifier
# Calibration Constants
variable_bottom: 27.75
variable_top: -2
variable_span: 27.4

# Tray position 
variable_toolhead_tray_pos_x: -22                # Nozzle X position
variable_toolhead_tray_pos_y: 329.00              # Nozzle Y position

# Speed setting
variable_toolhead_travel_speed: 500

# State Tracking (Persistence)
variable_cur_z: 27.75                # Defaults to DOWN/Bottom
variable_cur_tray: "IN"              # Defaults to Retracted

# Travel Time Delays (ms) - Used for proportional blocking
variable_delay_z: 650                # Max travel time for Z servo (Full Span)
variable_delay_tray: 350             # Max travel time for Tray servo (IN/OUT)

# Happy Hare Blob Tuning Parameters
variable_purge_start: 0.2
variable_z_raise: 12.0                # Total potential Z raise (mm)
variable_z_raise_exp: 0.85            # Exponential factor (1 is linear)
variable_max_iteration_length: 20.0   # Max mm per blob step
variable_iteration_z_raise: 2.5       # mm to raise Z per step
variable_eject_hop: 1.0               # Lift nozzle before ejection
variable_pressure_release_time: 2000  # ms (Cooling wait)
variable_retract_between_blobs: 2.0   # mm
variable_part_cooling_fan: 0.3        # 30% fan during purge
variable_part_cooling_fan_deposit: 1.0 # 100% fan to freeze blob
gcode: # Required but empty

#####################################################################
# CORE CONTROL MACRO
#####################################################################

[gcode_macro BLOBIFIER_SET]
description: Controls Z and Tray. Usage: BLOBIFIER_SET Z=[mm|UP|DOWN] TRAY=[IN|OUT] BLOCKING=[TRUE|FALSE]
gcode:
  {% set vars = printer["gcode_macro _BLOBIFIER_VARS"] %}
  {% set blocking = params.BLOCKING|default('FALSE')|upper == 'TRUE' %}
  
  {% set move_z = False %}
  {% set move_tray = False %}
  {% set z_wait = 0.0 %}
  {% set tray_wait = 0.0 %}

  # ----- Z-AXIS LOGIC -----
  {% if 'Z' in params %}
    {% set z_param = params.Z|upper %}
    {% if z_param == "UP" %}{% set z_pos = vars.top %}
    {% elif z_param == "DOWN" %}{% set z_pos = vars.bottom %}
    {% else %}{% set z_pos = z_param|float %}
    {% endif %}

    {% if z_pos != vars.cur_z %}
      {% set move_z = True %}
      {% set z_dist = (z_pos - vars.cur_z)|abs %}
      {% set z_wait = (z_dist / vars.span) * vars.delay_z %}
      
      {% set z_angle = (z_pos - vars.bottom) / (vars.top - vars.bottom) * 180 %}
      {% set z_angle = [0, [z_angle, 180]|min]|max %}
      
      SET_SERVO SERVO=blobifier_z ANGLE={z_angle}
      SET_GCODE_VARIABLE MACRO=_BLOBIFIER_VARS VARIABLE=cur_z VALUE={z_pos}
    {% endif %}
  {% endif %}

  # ----- TRAY LOGIC -----
  {% if 'TRAY' in params %}
    {% set tray_state = params.TRAY|upper %}
    {% if tray_state != vars.cur_tray %}
      {% set move_tray = True %}
      {% set tray_wait = vars.delay_tray %} 
      
      {% if tray_state == "IN" %} SET_SERVO SERVO=blob_tray ANGLE=180
      {% elif tray_state == "OUT" %} SET_SERVO SERVO=blob_tray ANGLE=0
      {% endif %}
      
      SET_GCODE_VARIABLE MACRO=_BLOBIFIER_VARS VARIABLE=cur_tray VALUE='"{tray_state}"'
    {% endif %}
  {% endif %}

  # ----- PROPORTIONAL BLOCKING LOGIC -----
  {% if blocking %}
    {% if move_z or move_tray %}
      {% set final_wait = [z_wait, tray_wait]|max %}
      G4 P{final_wait|int}
    {% endif %}
  {% endif %}

#####################################################################
# PURGE LOGIC
#####################################################################

[gcode_macro BLOBIFIER_PURGE]
description: Happy Hare style purge. Usage: BLOBIFIER_PURGE PURGE_LENGTH=[mm] Z_RAISE=[mm] E_SPEED=[mm/min]
gcode:
    {% set vars = printer["gcode_macro _BLOBIFIER_VARS"] %}
    {% set purge_len = params.PURGE_LENGTH|default(40)|float %}
    {% set local_z_raise = params.Z_RAISE|default(vars.z_raise)|float %}
    {% set local_e_speed = params.E_SPEED|default(600)|float %}
    
    {% set iterations = (purge_len / vars.max_iteration_length)|round(0, 'ceil')|int %}
    {% set step_purge = purge_len / iterations %}

    SAVE_GCODE_STATE NAME=blobifier_state
    
    # Corrected: G0 expects X and Y parameters, Z was passed as X previously
    G90 # Absolute positioning
    G0 X{vars.toolhead_tray_pos_x} Y{vars.toolhead_tray_pos_y} F{vars.toolhead_travel_speed*60}
    
    {% set old_fan = printer.fan.speed %}
    M106 S{(vars.part_cooling_fan * 255)|int}

    # 1. Setup Tray
    BLOBIFIER_SET TRAY=OUT Z=0 BLOCKING=TRUE
    M83 

    # 2. Purge Loop
    {% for i in range(iterations) %}
        {% set total_extruded_start = i * step_purge %}
        {% set total_extruded_end = (i + 1) * step_purge %}

        {% set z_start = ((total_extruded_start / purge_len)**vars.z_raise_exp) * local_z_raise %}
        {% set z_end = ((total_extruded_end / purge_len)**vars.z_raise_exp) * local_z_raise %}

        _BLOB_SYNC_MOVE Z_START={z_start} Z_END={z_end} E_DIST={step_purge} E_SPEED={local_e_speed} STEPS=100

        {% if i < (iterations - 1) %}
            G1 E-{vars.retract_between_blobs} F3000
            G4 P250
            G1 E{vars.retract_between_blobs} F3000
        {% endif %}
    {% endfor %}

    # 3. Pressure Release & Freeze
    M106 S{(vars.part_cooling_fan_deposit * 255)|int}
    G1 E-1.5 F3000
    {% set final_z = ((purge_len / purge_len)**vars.z_raise_exp) * local_z_raise %}
    BLOBIFIER_SET Z={final_z} BLOCKING=TRUE
    G4 P{vars.pressure_release_time}
    
    # 4. Eject
    _BLOB_EJECT_SEQUENCE

    M106 S{(old_fan * 255)|int}
    RESTORE_GCODE_STATE NAME=blobifier_state

#####################################################################
# UTILITY & HELPER MACROS
#####################################################################

[gcode_macro _BLOB_EJECT_SEQUENCE]
description: Multi-stage ejection sequence
gcode:
  BLOBIFIER_SET Z=DOWN TRAY=IN BLOCKING=TRUE
  _BLOB_TRAY_CYCLE N=2 POS=IN
  BLOBIFIER_SET Z=0 BLOCKING=TRUE
  _BLOB_TRAY_CYCLE N=2 POS=IN
  BLOBIFIER_SET Z=DOWN BLOCKING=TRUE

[gcode_macro _BLOB_TRAY_CYCLE]
description: Shake tray. Usage: _BLOB_TRAY_CYCLE N=2 POS=[IN|OUT]
gcode:
    {% set count = params.N|default(2)|int %}
    {% set target_pos = params.POS|upper|default("IN") %}

    {% for i in range(count) %}
       BLOBIFIER_SET TRAY=OUT BLOCKING=TRUE
       BLOBIFIER_SET TRAY=IN BLOCKING=TRUE
    {% endfor %}

    {% if target_pos == "OUT" %}
       BLOBIFIER_SET TRAY=OUT BLOCKING=TRUE
    {% endif %}

[gcode_macro _BLOB_SYNC_MOVE]
description: Internal helper to sync servo Z moves with extrusion via slicing
gcode:
    {% set z_start = params.Z_START|default(0)|float %}
    {% set z_end = params.Z_END|default(0)|float %}
    {% set e_dist = params.E_DIST|default(10)|float %}
    {% set e_speed = params.E_SPEED|default(300)|float %}
    {% set steps = params.STEPS|default(100)|int %}

    {% set e_step = e_dist / steps %}
    {% set z_total_dist = z_end - z_start %}
    {% set z_step_dist = z_total_dist / steps %}
    {% set step_time = (e_dist / (e_speed / 60)) / steps %}

    SAVE_GCODE_STATE NAME=blob_sync_state
    M83
    {% for i in range(steps) %}
        {% set current_z = z_start + (z_step_dist * (i + 1)) %}
        G1 E{e_step} F{e_speed}
        BLOBIFIER_SET Z={current_z}
        G4 P{(step_time * 1000)|int}
    {% endfor %}
    RESTORE_GCODE_STATE NAME=blob_sync_state
